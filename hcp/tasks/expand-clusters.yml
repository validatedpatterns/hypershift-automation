---
# Expand clusters that have a count parameter into individual cluster definitions
- name: "preflight | write clusters to temp file"
  ansible.builtin.copy:
    content: "{{ clusters | to_json }}"
    dest: "/tmp/clusters_expand_{{ ansible_date_time.epoch }}.json"
    mode: '0600'
  register: temp_file

- name: "preflight | expand clusters using shell script"
  ansible.builtin.shell: |
    python3 << 'PYTHON_SCRIPT'
    import json
    import sys
    
    with open('{{ temp_file.dest }}', 'r') as f:
        clusters = json.load(f)
    
    result = []
    
    for cluster in clusters:
        if cluster.get('count', 1) > 1:
            for i in range(1, cluster['count'] + 1):
                new_cluster = {k: v for k, v in cluster.items() if k != 'count'}
                new_cluster['name'] = cluster['name'] + '-' + str(i)
                result.append(new_cluster)
        else:
            result.append(cluster)
    
    print(json.dumps(result))
    PYTHON_SCRIPT
  register: expansion_result
  changed_when: false

- name: "preflight | cleanup temp file"
  ansible.builtin.file:
    path: "{{ temp_file.dest }}"
    state: absent

- name: "preflight | parse and set expanded clusters"
  ansible.builtin.set_fact:
    clusters: "{{ expansion_result.stdout | trim | from_json }}"
  vars:
    _original_clusters: "{{ clusters }}"

- name: "preflight | verify cluster expansion"
  ansible.builtin.debug:
    msg: "Expanded {{ clusters | length }} clusters: {{ clusters | map(attribute='name') | list }}"
make 