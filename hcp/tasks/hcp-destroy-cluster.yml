---
# Check for existing hostedcluster before attempting destruction
- name: "destroy | check if hostedcluster/{{ cluster.name }} exists"
  kubernetes.core.k8s_info:
    api_version: hypershift.openshift.io/v1beta1
    kind: HostedCluster
    namespace: clusters
    name: "{{ cluster.name }}"
  register: hc
  changed_when: false
  failed_when: false  # Don't fail if kubeconfig is not available

# Destroy the hypershift cluster when destroy = true and the cluster exists
- name: "destroy | destroy cluster {{ cluster.name }}"
  ansible.builtin.shell: >
    hcp destroy cluster aws
    --name {{ cluster.name }}
    --region {{ cluster.region }}
    --sts-creds {{ sts_creds.dir }}/{{ sts_creds.file }}
    --role-arn {{ hcp_role_arn }}
  args:
    executable: "{{lookup('ansible.builtin.env', 'SHELL')}}"
  async: 3600  # 1 hour timeout
  poll: 0  # Start in parallel, don't wait
  register: cluster_destroy_async
  when: 
    - destroy
    - hc.resources is defined
    - hc.resources | length > 0

# Wait for cluster destruction to complete
- name: "destroy | wait for cluster {{ cluster.name }} destruction to complete"
  ansible.builtin.async_status:
    jid: "{{ (cluster_destroy_async | default({})).ansible_job_id | default('') }}"
  register: cluster_destroy_result
  until: cluster_destroy_result.finished
  retries: 360  # 1 hour with 10 second intervals
  delay: 10
  failed_when: false  # Don't fail here - we'll check the result in the next step
  when: 
    - destroy
    - cluster_destroy_async is defined
    - (cluster_destroy_async | default({})).ansible_job_id is defined

# Verify that the destroy command succeeded
- name: "destroy | verify cluster {{ cluster.name }} destroy command succeeded"
  ansible.builtin.fail:
    msg: >
      Failed to destroy cluster {{ cluster.name }}.
      {% if cluster_destroy_result.finished | default(false) %}
      Error: {{ cluster_destroy_result.msg | default('Unknown error') }}.
      {% else %}
      The destroy command did not complete within the timeout period (1 hour).
      {% endif %}
      Check the async job output for details.
  when:
    - destroy
    - cluster_destroy_async is defined
    - (cluster_destroy_async | default({})).ansible_job_id is defined
    - not (cluster_destroy_result.finished | default(false) and not (cluster_destroy_result.failed | default(false)))

# Wait for hostedcluster to be deleted
- name: "destroy | wait for hostedcluster {{ cluster.name }} to be deleted | this can take a while"
  kubernetes.core.k8s_info:
    name: "{{ cluster.name }}"
    api_version: hypershift.openshift.io/v1beta1
    kind: hostedcluster
    namespace: clusters
  register: hc_status
  until: >
    hc_status.resources is not defined
    or hc_status.resources | length == 0
    or (
      hc_status.resources is defined
      and hc_status.resources | length > 0
      and hc_status.resources[0].metadata.deletionTimestamp is defined
      and (
        hc_status.resources[0].metadata.finalizers is not defined
        or hc_status.resources[0].metadata.finalizers | length == 0
      )
    )
  retries: "{{ (wait_timeout_seconds / check_interval_seconds) | int }}"
  delay: "{{ check_interval_seconds }}"
  failed_when: false  # Don't fail here - we'll check the result in the next step
  when: 
    - destroy
    - cluster_destroy_async is defined
    - cluster_destroy_result.finished | default(false)
    - not (cluster_destroy_result.failed | default(false))

# Final verification that the cluster was actually deleted
- name: "destroy | verify cluster {{ cluster.name }} was actually deleted"
  kubernetes.core.k8s_info:
    name: "{{ cluster.name }}"
    api_version: hypershift.openshift.io/v1beta1
    kind: HostedCluster
    namespace: clusters
  register: hc_final_check
  changed_when: false
  failed_when: false  # Don't fail if kubeconfig is not available, but check below
  when:
    - destroy
    - cluster_destroy_async is defined
    - cluster_destroy_result.finished | default(false)
    - not (cluster_destroy_result.failed | default(false))

# Check if cluster is stuck with finalizer but cloud resources are destroyed
- name: "destroy | check if cluster {{ cluster.name }} is stuck with finalizer"
  set_fact:
    hc_stuck_with_finalizer: >
      {{
        hc_final_check.resources is defined
        and hc_final_check.resources | length > 0
        and hc_final_check.resources[0].metadata.deletionTimestamp is defined
        and hc_final_check.resources[0].metadata.finalizers is defined
        and hc_final_check.resources[0].metadata.finalizers | length > 0
        and (
          hc_final_check.resources[0].status.conditions is defined
          and hc_final_check.resources[0].status.conditions | selectattr('type', 'equalto', 'CloudResourcesDestroyed') | selectattr('status', 'equalto', 'True') | list | length > 0
        )
      }}
  when:
    - destroy
    - cluster_destroy_async is defined
    - cluster_destroy_result.finished | default(false)
    - not (cluster_destroy_result.failed | default(false))
    - hc_final_check.resources is defined
    - hc_final_check.resources | length > 0

# Attempt to remove finalizer if cloud resources are destroyed
- name: "destroy | attempt to remove finalizer from stuck cluster {{ cluster.name }}"
  ansible.builtin.shell: >
    kubectl patch hostedcluster {{ cluster.name }} -n clusters
    --type=json
    -p='[{"op": "remove", "path": "/metadata/finalizers"}]'
  args:
    executable: "{{lookup('ansible.builtin.env', 'SHELL')}}"
  register: hc_finalizer_removal
  changed_when: hc_finalizer_removal.rc == 0
  failed_when: false  # Don't fail if we can't remove the finalizer
  when:
    - destroy
    - cluster_destroy_async is defined
    - cluster_destroy_result.finished | default(false)
    - not (cluster_destroy_result.failed | default(false))
    - hc_stuck_with_finalizer | default(false)

# Wait a bit more after removing finalizer
- name: "destroy | wait for cluster {{ cluster.name }} to be deleted after finalizer removal"
  kubernetes.core.k8s_info:
    name: "{{ cluster.name }}"
    api_version: hypershift.openshift.io/v1beta1
    kind: HostedCluster
    namespace: clusters
  register: hc_post_finalizer_check
  until: hc_post_finalizer_check.resources is not defined or hc_post_finalizer_check.resources | length == 0
  retries: 30  # 5 minutes with 10 second intervals
  delay: 10
  failed_when: false
  when:
    - destroy
    - cluster_destroy_async is defined
    - cluster_destroy_result.finished | default(false)
    - not (cluster_destroy_result.failed | default(false))
    - hc_stuck_with_finalizer | default(false)
    - hc_finalizer_removal.rc | default(1) == 0

# Fail if cluster still exists after deletion attempt
- name: "destroy | fail if cluster {{ cluster.name }} still exists"
  ansible.builtin.fail:
    msg: >
      Cluster {{ cluster.name }} still exists after destroy attempt.
      {% if hc_final_check.resources[0].metadata.deletionTimestamp is defined %}
      The cluster is marked for deletion but may be stuck with a finalizer.
      {% if hc_final_check.resources[0].status is defined and hc_final_check.resources[0].status.conditions is defined %}
      Cloud resources status: {{ hc_final_check.resources[0].status.conditions | selectattr('type', 'equalto', 'CloudResourcesDestroyed') | map(attribute='status') | first | default('Unknown') }}.
      {% endif %}
      {% else %}
      The cluster may not have been fully deleted.
      {% endif %}
      You may need to manually remove the finalizer or check the hypershift operator logs.
  when:
    - destroy
    - cluster_destroy_async is defined
    - cluster_destroy_result.finished | default(false)
    - not (cluster_destroy_result.failed | default(false))
    - hc_final_check.resources is defined
    - hc_final_check.resources | length > 0
    - not (hc_stuck_with_finalizer | default(false) and hc_finalizer_removal.rc | default(1) == 0)

# Clean up local deployment directory
- name: "destroy | remove local deployment directory for {{ cluster.name }}"
  ansible.builtin.file:
    state: absent
    path: "{{ deployment_dir }}/{{ cluster.name }}"
  when: destroy

# Display message if cluster doesn't exist
- name: "destroy | warn if cluster {{ cluster.name }} does not exist"
  ansible.builtin.debug:
    msg: "Cluster {{ cluster.name }} does not exist, skipping destruction"
  when:
    - destroy
    - hc.resources is not defined or hc.resources | length == 0



