---
# Check for existing hostedcluster before attempting destruction
- name: "destroy | check if hostedcluster/{{ cluster.name }} exists"
  kubernetes.core.k8s_info:
    api_version: hypershift.openshift.io/v1beta1
    kind: HostedCluster
    namespace: clusters
    name: "{{ cluster.name }}"
  register: hc
  changed_when: false
  failed_when: false  # Don't fail if kubeconfig is not available

# Destroy the hypershift cluster when destroy = true and the cluster exists
- name: "destroy | destroy cluster {{ cluster.name }}"
  ansible.builtin.shell: >
    hcp destroy cluster aws
    --name {{ cluster.name }}
    --region {{ cluster.region }}
    --sts-creds {{ sts_creds.dir }}/{{ sts_creds.file }}
    --role-arn {{ hcp_role_arn }}
  args:
    executable: "{{lookup('ansible.builtin.env', 'SHELL')}}"
  async: 3600  # 1 hour timeout
  poll: 0  # Start in parallel, don't wait
  register: cluster_destroy_async
  when: 
    - destroy
    - hc.resources is defined
    - hc.resources | length > 0

# Wait for cluster destruction to complete
- name: "destroy | wait for cluster {{ cluster.name }} destruction to complete"
  ansible.builtin.async_status:
    jid: "{{ (cluster_destroy_async | default({})).ansible_job_id | default('') }}"
  register: cluster_destroy_result
  until: cluster_destroy_result.finished
  retries: 360  # 1 hour with 10 second intervals
  delay: 10
  failed_when: false  # Don't fail here - we'll check the result in the next step
  when: 
    - destroy
    - cluster_destroy_async is defined
    - (cluster_destroy_async | default({})).ansible_job_id is defined

# Verify that the destroy command succeeded
- name: "destroy | verify cluster {{ cluster.name }} destroy command succeeded"
  ansible.builtin.fail:
    msg: >
      Failed to destroy cluster {{ cluster.name }}.
      {% if cluster_destroy_result.finished | default(false) %}
      Error: {{ cluster_destroy_result.msg | default('Unknown error') }}.
      {% else %}
      The destroy command did not complete within the timeout period (1 hour).
      {% endif %}
      Check the async job output for details.
  when:
    - destroy
    - cluster_destroy_async is defined
    - (cluster_destroy_async | default({})).ansible_job_id is defined
    - not (cluster_destroy_result.finished | default(false) and not (cluster_destroy_result.failed | default(false)))

# Wait for hostedcluster to be deleted
- name: "destroy | wait for hostedcluster {{ cluster.name }} to be deleted | this can take a while"
  kubernetes.core.k8s_info:
    name: "{{ cluster.name }}"
    api_version: hypershift.openshift.io/v1beta1
    kind: hostedcluster
    namespace: clusters
  register: hc_status
  until: hc_status.resources is not defined or hc_status.resources | length == 0
  retries: "{{ (wait_timeout_seconds / check_interval_seconds) | int }}"
  delay: "{{ check_interval_seconds }}"
  failed_when: >
    hc_status.resources is defined
    and hc_status.resources | length > 0
  when: 
    - destroy
    - cluster_destroy_async is defined
    - cluster_destroy_result.finished | default(false)
    - not (cluster_destroy_result.failed | default(false))

# Final verification that the cluster was actually deleted
- name: "destroy | verify cluster {{ cluster.name }} was actually deleted"
  kubernetes.core.k8s_info:
    name: "{{ cluster.name }}"
    api_version: hypershift.openshift.io/v1beta1
    kind: HostedCluster
    namespace: clusters
  register: hc_final_check
  changed_when: false
  failed_when: false  # Don't fail if kubeconfig is not available, but check below
  when:
    - destroy
    - cluster_destroy_async is defined
    - cluster_destroy_result.finished | default(false)
    - not (cluster_destroy_result.failed | default(false))

# Fail if cluster still exists after deletion attempt
- name: "destroy | fail if cluster {{ cluster.name }} still exists"
  ansible.builtin.fail:
    msg: "Cluster {{ cluster.name }} still exists after destroy attempt. The cluster may not have been fully deleted."
  when:
    - destroy
    - cluster_destroy_async is defined
    - cluster_destroy_result.finished | default(false)
    - not (cluster_destroy_result.failed | default(false))
    - hc_final_check.resources is defined
    - hc_final_check.resources | length > 0

# Clean up local deployment directory
- name: "destroy | remove local deployment directory for {{ cluster.name }}"
  ansible.builtin.file:
    state: absent
    path: "{{ deployment_dir }}/{{ cluster.name }}"
  when: destroy

# Display message if cluster doesn't exist
- name: "destroy | warn if cluster {{ cluster.name }} does not exist"
  ansible.builtin.debug:
    msg: "Cluster {{ cluster.name }} does not exist, skipping destruction"
  when:
    - destroy
    - hc.resources is not defined or hc.resources | length == 0



