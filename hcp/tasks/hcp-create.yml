# The iam.hcp_role_name must exist for this to succeed
- name: "preflight | Get the {{ iam.hcp_role }} ARN"
  ansible.builtin.import_tasks: role-facts.yml

# Check if kubeconfig is needed
- name: "preflight | check if kubeconfig is needed"
  set_fact:
    need_kubeconfig: "{{ clusters | selectattr('image', 'equalto', 'default') | list | length > 0 }}"
  when: create

# Get clusterversion once for all clusters (if any use default)
- name: "deploy | get clusterversion from hosting cluster"
  kubernetes.core.k8s_info:
    api_version: config.openshift.io/v1
    kind: ClusterVersion
  register: clusterversion
  failed_when: false  # Don't fail if kubeconfig is not available
  changed_when: false
  when: 
    - create
    - need_kubeconfig | default(false)

- name: "deploy | warn if kubeconfig not available and default image is used"
  ansible.builtin.debug:
    msg: "WARNING: Kubeconfig not available. Clusters with image: default will be skipped. Please configure kubeconfig or use a specific image version."
  when:
    - create
    - need_kubeconfig | default(false)
    - clusterversion.resources is not defined or clusterversion.resources | length == 0

- name: "deploy | set default version fact"
  set_fact:
    default_version: "{{ clusterversion.resources[0].status.desired.version }}"
  when: 
    - create
    - clusterversion.resources is defined
    - clusterversion.resources | length > 0
    - clusterversion.resources[0].status is defined
    - clusterversion.resources[0].status.desired is defined
    - clusterversion.resources[0].status.desired.version is defined

# Loop over clusters and expand count inline - run in parallel
- name: "deploy | create clusters (parallel)"
  include_tasks: hcp-create-cluster-expanded.yml
  loop: "{{ clusters }}"
  loop_control:
    loop_var: cluster_item
  when: create and not destroy
